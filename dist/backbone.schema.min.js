/**
 * Backbone.Schema v0.5.1
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2014 Dmytro Nemoga
 * Released under the MIT license
 */
!function(a){"use strict";var b="object"==typeof module&&"object"==typeof exports,c=b?{_:require("underscore"),Backbone:require("backbone"),moment:require("moment")}:window;(b?exports:Backbone).Schema=a(c,b)}(function(a){"use strict";var b=a._,c=a.Backbone,d=a.moment,e=c.Schema=function(a){if(!(this instanceof e))return new e(a);var d=b.extend(this,{model:a},{attributes:{}});b.extend(a,{toJSON:b.wrap(a.toJSON,function(a,d){var e=a.call(this,d);return b.each(e,function(a,e,f){a instanceof c.Model?a=a.source?a.id:a.toJSON(d):a instanceof c.Collection&&(a=a.source?b.pluck(a.models,"id"):a.toJSON(d)),f[e]=a}),e}),get:b.wrap(a.get,function(a,b){var c=d.attributes[b],e=c&&c.getter,f=a.call(this,b);return e?e(b,f):f}),set:b.wrap(a.set,function(a,c,e,f){var g;!c||b.isObject(c)?(g=c,f=e):(g={})[c]=e;var h={};return b.each(g,function(a,c,e){var f=d.attributes[c],g=f&&f.setter,i=g?g(c,a):b.pick(e,c);b.each(i,function(a,b){h[b]=a})}),a.call(this,h,f)})})};return b.extend(e,{extend:c.Model.extend},{handlers:{string:{getter:function(a,b){return b},setter:function(a,c){return b.isString(c)?c:String(c)}},"boolean":{getter:function(a,b){return b},setter:function(a,c){return b.isBoolean(c)?c:Boolean(c)}},number:{getter:function(a,b){return b},setter:function(a,c){var d=Number(c);return isNaN(d)&&(d=b.isString(c)?c:String(c)),b.isNumber(d)?d:"NaN"}},datetime:{getter:function(a,b,c){var e=c.format;return d.isMoment(b)||(b=d(b)),e?b.format(e):b},setter:function(a,b,c){var e=c.standard;d.isMoment(b)||(b=d(b));var f;switch(e){case"iso":f=b.toISOString();break;case"unix":f=b.unix();break;default:f=b.toDate()}return f}},model:{getter:function(a,b){return b},setter:function(a,d,e){e=b.clone(e);var f,g=e.source,h=e.clear;f=e.model||g.model;var i,j=this.model.get(a);return i=d instanceof c.Model?d===j?d:b.clone(d.attributes):g?g.get(d):d,i instanceof f?j=i:j instanceof f?h?j.clear().set(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j}},collection:{getter:function(a,b){return b},setter:function(a,d,e){e=b.clone(e);var f,g=e.source,h=e.reset;f=e.collection||g.constructor;var i,j=this.model.get(a);return i=d instanceof c.Collection?d===j?d:b.clone(d.models):g?g.filter(function(a){return b.contains(d,a.id)}):d,i instanceof f?j=i:j instanceof f?h?j.reset(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j}}}}),b.extend(e.prototype,{constructor:e},{define:function(a,c){var d;return!a||b.isObject(a)?d=a:(d={})[a]=c,b.each(d,function(a,b){a=a||{},this._addAttribute(b,a)},this),this.refresh(),this},refresh:function(){var a=this.attributes,c={};return b.each(a,function(a,b){c[b]=this.model.attributes[b]},this),this.model.set(c),this},defaultValue:function(a){var c=b.result(this.model,"defaults");return c&&b.has(c,a)?c[a]:null},_addAttribute:function(a,c){var d=c.type,e=c.array,f=c.model,g=c.collection;d||(e?d=e:f?d="model":g&&(d="collection"));var h=this.constructor,i=this,j=h.handlers[d],k=j&&j.getter,l=j&&j.setter;return this.attributes[a]=b.defaults(c,{getter:b.wrap(k,function(a,d,f){var g=[],h=e?f:[f];return b.each(h,function(e){var f;f=b.isNull(e)?e:a?a.call(this,d,e,c):e,g.push(f)},this),e?g:g[0]}),setter:b.wrap(l,function(a,f,g){var h=[],j=e?g:[g];return b.each(j,function(e){b.isUndefined(e)&&(e=i.defaultValue(f));var g;if(b.isNull(e))switch(d){case"model":g=a?a.call(this,f,{},c):e;break;case"collection":g=a?a.call(this,f,[],c):e;break;default:g=e}else g=a?a.call(this,f,e,c):e;h.push(g)},this),b.object([f],[e?h:h[0]])})}),this._bindHandlers(c),this},_bindHandlers:function(a){var c=a.getter,d=a.setter;return c&&(a.getter=b.bind(c,this)),d&&(a.setter=b.bind(d,this)),this}}),e});