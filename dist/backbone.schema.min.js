/**
 * Backbone.Schema v0.5.0
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2014 Dmytro Nemoga
 * Released under the MIT license
 */
!function(a){"use strict";var b="object"==typeof module&&"object"==typeof exports,c=b?{_:require("underscore"),Backbone:require("backbone"),moment:require("moment")}:window;(b?exports:Backbone).Schema=a(c,b)}(function(a){"use strict";var b,c=a._,d=a.Backbone,e=a.moment,f=d.Schema=function(a){return this instanceof f?(b=c.extend(this,{model:a},{attributes:{}}),void c.extend(a,{toJSON:c.wrap(a.toJSON,function(a,b){var e=a.call(this,b);return c.each(e,function(a,e,f){a instanceof d.Model?a=a.source?a.id:a.toJSON(b):a instanceof d.Collection&&(a=a.source?c.pluck(a.models,"id"):a.toJSON(b)),f[e]=a}),e}),get:c.wrap(a.get,function(a,c){var d=b.attributes[c],e=d&&d.getter,f=a.call(this,c);return e?e(c,f):f}),set:c.wrap(a.set,function(a,d,e,f){var g;!d||c.isObject(d)?(g=d,f=e):(g={})[d]=e;var h={};return c.each(g,function(a,d,e){var f=b.attributes[d],g=f&&f.setter,i=g?g(d,a):c.pick(e,d);c.each(i,function(a,b){h[b]=a})}),a.call(this,h,f)})})):new f(a)};return c.extend(f,{extend:d.Model.extend},{handlers:{string:{getter:function(a,b){return b},setter:function(a,b){return c.isString(b)?b:String(b)}},"boolean":{getter:function(a,b){return b},setter:function(a,b){return c.isBoolean(b)?b:Boolean(b)}},number:{getter:function(a,b){return b},setter:function(a,b){var d=Number(b);return isNaN(d)&&(d=c.isString(b)?b:String(b)),c.isNumber(d)?d:"NaN"}},datetime:{getter:function(a,b,c){var d=c.format;return e.isMoment(b)||(b=e(b)),d?b.format(d):b},setter:function(a,b,c){var d=c.standard;e.isMoment(b)||(b=e(b));var f;switch(d){case"iso":f=b.toISOString();break;case"unix":f=b.unix();break;default:f=b.toDate()}return f}},model:{getter:function(a,b){return b},setter:function(a,b,e){e=c.clone(e);var f,g=e.source,h=e.clear;f=e.model||g.model;var i,j=this.model.get(a);return i=b instanceof d.Model?b===j?b:c.clone(b.attributes):g?g.get(b):b,i instanceof f?j=i:j instanceof f?h?j.clear().set(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j}},collection:{getter:function(a,b){return b},setter:function(a,b,e){e=c.clone(e);var f,g=e.source,h=e.reset;f=e.collection||g.constructor;var i,j=this.model.get(a);return i=b instanceof d.Collection?b===j?b:c.clone(b.models):g?g.filter(function(a){return c.contains(b,a.id)}):b,i instanceof f?j=i:j instanceof f?h?j.reset(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j}}}}),c.extend(f.prototype,{constructor:f},{define:function(a,b){var d;return!a||c.isObject(a)?d=a:(d={})[a]=b,c.each(d,function(a,b){a=a||{},this._addAttribute(b,a)},this),this.refresh(),this},refresh:function(){var a=this.attributes,b={};return c.each(a,function(a,c){b[c]=this.model.attributes[c]},this),this.model.set(b),this},defaultValue:function(a){var b=c.result(this.model,"defaults");return b&&c.has(b,a)?b[a]:null},_addAttribute:function(a,d){var e=d.type,f=d.array,g=d.model,h=d.collection;e||(f?e=f:g?e="model":h&&(e="collection"));var i=this.constructor,j=i.handlers[e],k=j&&j.getter,l=j&&j.setter;return this.attributes[a]=c.defaults(d,{getter:c.wrap(k,function(a,b,e){var g=[],h=f?e:[e];return c.each(h,function(e){var f;f=c.isNull(e)?e:a?a.call(this,b,e,d):e,g.push(f)},this),f?g:g[0]}),setter:c.wrap(l,function(a,g,h){var i=[],j=f?h:[h];return c.each(j,function(f){c.isUndefined(f)&&(f=b.defaultValue(g));var h;if(c.isNull(f))switch(e){case"model":h=a?a.call(this,g,{},d):f;break;case"collection":h=a?a.call(this,g,[],d):f;break;default:h=f}else h=a?a.call(this,g,f,d):f;i.push(h)},this),c.object([g],[f?i:i[0]])})}),this._bindHandlers(d),this},_bindHandlers:function(a){var b=a.getter,d=a.setter;return b&&(a.getter=c.bind(b,this)),d&&(a.setter=c.bind(d,this)),this}}),f});